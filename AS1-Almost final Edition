#include <stdio.h>
#include <unistd.h>
#include <string.h>
#include <stddef.h>
#include <stdlib.h>

#define MAX_LINE 80
#define MIN_ID 1
#define MAX_ID 10
#define NOT_ID 0


typedef struct
{
    pid_t pid;
    char userInput[MAX_LINE + 1];
} record;

void free_args(char **args, unsigned nargs)
{
    unsigned i;
    for (i = 0; i < nargs; i++)
        free(args[i]);
}

int parse_userInput(char *userInput, char *buf, char **args, unsigned nargs, unsigned max_nargs)
{
    char *token;
    unsigned len;
    unsigned i;
    free_args(args, nargs);
    nargs = 0;
    for (i = 0; i < max_nargs; i++)
        args[i] = NULL;

    len = strlen(userInput);
    if (len > 0 && userInput[len - 1] == '\n')
        userInput[--len] = '\0';

        strcpy(buf, userInput);
        token = strtok(buf, " ");

    if (!token) {
        args[nargs] = strdup(buf);
        return ++nargs;
    }

    while (token && nargs + 1 < max_nargs) {
        args[nargs] = strdup(token);
        nargs++;
        token = strtok(NULL, " ");
    }
    if (token) {
        free_args(args, nargs);
        return 0;
    }
    return nargs;
}

int parse_number(const char *str, char *buf, int *num)
{
    if (sscanf(str, "%d", num) != 1)
        return 0;
    sprintf(buf, "%d", *num);
    if (0 != strcmp(buf, str))
        return 0;
    return 1;
}


int main(void)
{
    char *args[MAX_LINE/2 + 1];
    char userInput[MAX_LINE + 2];
    char buf[MAX_LINE + 2];
    int nargs = 0;
    const int max_nargs = MAX_LINE/2 + 1;
    pid_t pid;
    record history[MAX_ID];
    int last_id = NOT_ID;
    int i;
    int num;
    int should_run = 1;

    while (should_run) {
        printf("CSCI3120>");
        fflush(stdout);

        if (!fgets(userInput, sizeof(userInput), stdin))
            exit(0);

        if (!(nargs = parse_userInput(userInput, buf, args, nargs, max_nargs)))
            exit(0);

        if (!strcspn(args[0], " ")) {
            continue;
        }

        if (0 == strcmp(args[0], "exit")) {
            if (nargs != 1) {
                printf("Wrong Input\n");
            } else {
                should_run = 0;
            }
            continue;
        }

        if (0 == strcmp(args[0], "history")) {
            if (nargs != 1) {
                printf("Wrong Input\n");
            } else if (last_id == NOT_ID) {
                printf("No userInput in the history\n");
            } else {
                printf("%-5s%-9s%s\n", "ID", "PID", "userInput");
                for (i = 0; i < last_id; i++) {
                    printf("%-5d%-9d%s\n", i + 1, history[i].pid, history[i].userInput);
                }
            }
            continue;
        }

        if (0 == strcmp(args[0], "!!")) {
            if (nargs != 1) {
                printf("Wrong Input\n");
                continue;
            } else if (last_id == NOT_ID) {
                printf("No userInput in the history\n");
                continue;
            } else {
                strcpy(userInput, history[last_id - 1].userInput);
                nargs = parse_userInput(userInput, buf, args, nargs, max_nargs);
            }
        }

        if (args[0][0] == '!') {
            if (nargs != 1 || !parse_number(args[0] + 1, buf, &num)) {
                printf("Wrong Input\n");
                continue;
            } else if (num < MIN_ID || num > last_id) {
                printf("No userInput in the history\n");
                continue;
            } else {
                strcpy(userInput, history[num - 1].userInput);
                nargs = parse_userInput(userInput, buf, args, nargs, max_nargs);
            }
        }

        pid = fork();
        if (pid < 0)
            exit(0);
        if (pid == 0) {
            if (-1 == execvp(args[0], args)) {
                printf("Wrong Input\n");
                exit(0);
            }
        }
        if (pid > 0) {
            if (last_id >= MAX_ID) {
                for (i = MIN_ID; i < MAX_ID; i++)
                    history[i - 1] = history[i];
                    last_id = MAX_ID - 1;
            }
            history[last_id].pid = pid;
            strcpy(history[last_id].userInput, userInput);
            last_id++;
            
        }
    }
    return 0;
}
